<!-- pmo_hub\core\templates\admin\core\pmo.html -->
{% extends "admin/base_site.html" %}
{% load static %}

{% block extrahead %}
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>

<style>
    .pmo-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin: 20px 0; }
    .card-pmo { border-top: 4px solid #17a2b8; padding: 15px; background: #fff; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .gantt-wrapper { background: #fff; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6; margin-top: 20px; min-height: 400px; }
    .risk-item { color: #d9534f; margin-bottom: 8px; font-size: 13px; border-left: 3px solid #d9534f; padding-left: 8px; }
</style>
{% endblock %}

{% block content %}
<div id="content-main">
    <h1>PMO Dashboard - Vis√£o Integrada</h1>

    <div style="background: #fff; padding: 15px; border-radius: 8px; border: 1px solid #dee2e6;">
        <form method="get">
            <select id="temas-select" name="temas" multiple placeholder="Filtrar temas...">
                {% for tema in todos_temas %}
                    <option value="{{ tema.id }}" {% if tema.id|stringformat:"i" in temas_selecionados %}selected{% endif %}>{{ tema.nome }}</option>
                {% endfor %}
            </select>
            <button type="submit" class="button" style="margin-top:10px;">Atualizar Dashboard</button>
        </form>
    </div>

    <div class="pmo-grid">
        <div class="card-pmo">
            <h3>üìä Principais Avan√ßos</h3>
            <ul>
                {% for d in demandas_globais %}
                    <li><strong>{{ d.titulo }}</strong> ({{ d.porcentagem_concluida }}%)</li>
                {% endfor %}
            </ul>
        </div>
        <div class="card-pmo" style="border-top-color: #28a745;">
            <h3>‚è© Pr√≥ximos Passos</h3>
            {% for d in demandas_globais %}
                {% if d.proximos_passos %}<p>‚Ä¢ {{ d.proximos_passos }}</p>{% endif %}
            {% endfor %}
        </div>
        <div class="card-pmo" style="border-top-color: #ffc107;">
            <h3>‚ö†Ô∏è Riscos Cr√≠ticos</h3>
            {% for d in demandas_globais %}
                {% for risco in d.riscos.all %}
                    <div class="risk-item"><strong>{{ d.tema.nome }}:</strong> {{ risco.nome }}</div>
                {% endfor %}
            {% endfor %}
        </div>
    </div>

    <div class="gantt-wrapper">
        <h3 style="margin-bottom: 15px;">Cronograma Integrado de Projetos</h3>
        <div id="gantt_consolidado"></div>
    </div>
</div>

<script type="text/javascript">
    new TomSelect('#temas-select', { plugins: ['remove_button'] });

    google.charts.load('current', {'packages':['gantt']});
    google.charts.setOnLoadCallback(drawChart);

    function drawChart() {
        var data = new google.visualization.DataTable();
        data.addColumn('string', 'Task ID');
        data.addColumn('string', 'Task Name');
        data.addColumn('string', 'Resource'); // TEMA para colora√ß√£o
        data.addColumn('date', 'Start Date');
        data.addColumn('date', 'End Date');
        data.addColumn('number', 'Duration');
        data.addColumn('number', 'Percent Complete');
        data.addColumn('string', 'Dependencies');

        data.addRows([
            {% for d in demandas_globais %}
            [
                '{{ d.id }}', 
                '{{ d.titulo|escapejs }}', 
                '{{ d.tema.nome|default:"Geral"|escapejs }}', 
                new Date({{ d.data_inicio|date:"Y, n-1, j" }}), 
                new Date({{ d.data_prazo|date:"Y, n-1, j"|default:d.data_inicio|date:"Y, n-1, j" }}), 
                null, 
                {{ d.porcentagem_concluida }}, 
                null
            ],
            {% endfor %}
        ]);

        var options = {
            height: {{ demandas_globais|length|add:2 }} * 45,
            gantt: {
                trackHeight: 40,
                barHeight: 30,
                criticalPathEnabled: false,
                percentEnabled: true,
                labelStyle: { fontName: 'Roboto', fontSize: 13 }
            },
            hAxis: {
                viewWindow: {
                    // Valores injetados dinamicamente pelo Django
                    min: new Date({{ data_min_js }}),
                    max: new Date({{ data_max_js }})
                },
                gridlines: { color: '#e9ecef' }
            }
        };

        var chart = new google.visualization.Gantt(document.getElementById('gantt_consolidado'));
        chart.draw(data, options);
    }
</script>
{% endblock %}