<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DataHub Dashboard | Kanban</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body { background-color: #f4f7f6; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .navbar-custom { background-color: #ffffff; border-bottom: 1px solid #e0e0e0; padding: 15px 30px; }
        .kanban-container { display: flex; overflow-x: auto; padding: 20px; gap: 1.2rem; align-items: flex-start; }
        .kanban-column { background: #ebedf0; min-width: 320px; max-width: 320px; border-radius: 10px; padding: 15px; min-height: 70vh; box-shadow: inset 0 0 5px rgba(0,0,0,0.05); }
        .kanban-header { font-weight: bold; margin-bottom: 15px; text-transform: uppercase; font-size: 0.85rem; color: #5e6c84; display: flex; justify-content: space-between; }
        .kanban-card { background: white; border-radius: 8px; padding: 15px; margin-bottom: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-left: 6px solid #ccc; transition: transform 0.2s; cursor: pointer; }
        .kanban-card:hover { transform: translateY(-3px); box-shadow: 0 6px 12px rgba(0,0,0,0.1); }
        .kanban-card h6 { margin: 0 0 8px 0; font-size: 14px; color: #172b4d; }
        .kanban-card .meta-info { font-size: 12px; color: #6b778c; display: flex; justify-content: space-between; margin-top: 10px; }
        .dashboard-card { border: none; border-radius: 12px; transition: 0.3s; }
    </style>
</head>
<body>

    <nav class="navbar-custom d-flex justify-content-between align-items-center">
        <h4 class="m-0"><i class="fas fa-chart-line text-primary me-2"></i>DataHub</h4>
        <div>
            <a href="{% url 'admin:index' %}" class="btn btn-sm btn-outline-primary me-2"><i class="fas fa-cog"></i> Admin</a>
            <a href="?logout=1" class="btn btn-sm btn-danger"><i class="fas fa-sign-out-alt"></i> Sair</a>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        
        <div class="row">
            <div class="col-12">
                <h5 class="px-3 mb-3 fw-bold">Quadro Kanban</h5>
                <div class="kanban-container">
                    {% for situacao, tarefas in kanban_data.items %}
                    <div class="kanban-column">
                        <div class="kanban-header">
                            <span>{{ situacao.nome }}</span>
                            <span class="badge bg-white text-dark border">{{ tarefas|length }}</span>
                        </div>
                        
                        {% for d in tarefas %}
                        <div class="kanban-card" style="border-left-color: {{ situacao.cor_hex }}" onclick="window.open('{% url 'admin:core_demanda_change' d.id %}', '_blank')">
                            <span class="badge bg-light text-dark mb-2" style="font-size: 10px;">{{ d.tema }}</span>
                            <h6>{{ d.titulo }}</h6>
                            <div class="meta-info">
                                <span><i class="far fa-user me-1"></i> 
                                    {% if d.responsavel %}
                                        {{ d.responsavel.username }}
                                    {% else %}
                                        ---
                                    {% endif %}
                                </span>
                                <span><i class="far fa-calendar-alt me-1"></i> {{ d.data_prazo|date:"d/m"|default:"--" }}</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
<!-- 
        <div class="row my-5 px-3">
            <div class="col-md-6 mb-4 text-center">
                <div class="card dashboard-card p-4">
                    <h6 class="fw-bold mb-4">Status</h6>
                    <canvas id="chartSituacao"></canvas>
                </div>
            </div>
            <div class="col-md-6 mb-4 text-center">
                <div class="card dashboard-card p-4">
                    <h6 class="fw-bold mb-4">Nível</h6>
                    <canvas id="chartNivel"></canvas>
                </div>
            </div>
        </div> -->

        <div class="row px-3 pb-5">
            <div class="col-12">
                <div class="card dashboard-card">
                    <div class="card-header bg-white py-3"><h6 class="m-0 fw-bold">Lista de Demandas</h6></div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th class="ps-4">Demanda</th>
                                        <th>Situação</th>
                                        <th>Responsável</th>
                                        <th>Prazo</th>
                                        <th class="text-center">Ação</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for demanda in demandas %}
                                    <tr>
                                        <td class="ps-4">
                                            <strong>{{ demanda.titulo }}</strong><br>
                                            <small class="text-muted">{{ demanda.tema }}</small>
                                        </td>
                                        <td>
                                            {% if demanda.situacao %}
                                            <span class="badge" style="background-color: {{ demanda.situacao.cor_hex }}">
                                                {{ demanda.situacao.nome }}
                                            </span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if demanda.responsavel %}
                                                {{ demanda.responsavel.get_full_name|default:demanda.responsavel.username }}
                                            {% else %}
                                                <span class="text-muted">Não atribuído</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ demanda.data_prazo|date:"d/m/Y"|default:"---" }}</td>
                                        <td class="text-center">
                                            <a href="{% url 'admin:core_demanda_change' demanda.id %}" target="_blank" class="text-primary">
                                                <i class="fas fa-external-link-alt"></i>
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Gráfico Status
        new Chart(document.getElementById('chartSituacao'), {
            type: 'doughnut',
            data: {
                labels: {{ labels_situacao|safe }},
                datasets: [{
                    data: {{ counts_situacao|safe }},
                    backgroundColor: {{ cores_situacao|safe }}
                }]
            }
        });

        // Gráfico Nível
        new Chart(document.getElementById('chartNivel'), {
            type: 'bar',
            data: {
                labels: {{ labels_tema|safe }},
                datasets: [{
                    label: 'Quantidade',
                    data: {{ counts_tema|safe }},
                    backgroundColor: '#4e73df'
                }]
            }
        });
    </script>
</body>
</html>