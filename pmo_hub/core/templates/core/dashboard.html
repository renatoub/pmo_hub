<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DataHub Dashboard | Kanban</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body { background-color: #f4f7f6; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .navbar-custom { background-color: #ffffff; border-bottom: 1px solid #e0e0e0; padding: 15px 30px; }
        
        /* Container Kanban equalizado */
        .kanban-container { 
            display: flex; 
            overflow-x: auto; 
            padding: 20px; 
            gap: 1.2rem; 
            align-items: stretch; 
        }

        .kanban-column { 
            background: #ebedf0; 
            min-width: 320px; 
            max-width: 320px; 
            border-radius: 10px; 
            padding: 15px; 
            display: flex;
            flex-direction: column;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.05);
            height: auto;
        }

        .kanban-header { 
            font-weight: bold; margin-bottom: 15px; text-transform: uppercase; 
            font-size: 0.85rem; color: #5e6c84; display: flex; justify-content: space-between; 
        }

        .kanban-cards-wrapper { flex-grow: 1; min-height: 100px; }

        .kanban-card { 
            background: white; border-radius: 8px; padding: 15px; margin-bottom: 12px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-left: 6px solid #ccc; 
            transition: transform 0.2s; cursor: pointer; 
        }
        .kanban-card:hover { transform: translateY(-3px); box-shadow: 0 6px 12px rgba(0,0,0,0.1); }
        .kanban-card h6 { margin: 0 0 8px 0; font-size: 14px; color: #172b4d; }
        .kanban-card .meta-info { font-size: 11px; color: #6b778c; margin-top: 10px; }

        /* Estilos Filtros */
        .filter-bar { background: white; padding: 15px 30px; border-bottom: 1px solid #e2e8f0; display: flex; gap: 1.5rem; align-items: flex-end; }
        .multi-select-box { position: relative; width: 220px; }
        .multi-select-menu { 
            display: none; position: absolute; background: white; z-index: 1000; 
            width: 100%; max-height: 250px; overflow-y: auto; 
            border: 1px solid #ddd; border-radius: 4px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            padding: 8px;
        }
        .multi-select-box:hover .multi-select-menu { display: block; }
        .opt-item { font-size: 12px; display: flex; align-items: center; gap: 8px; padding: 4px 0; cursor: pointer; }
        .opt-item:hover { background: #f8f9fa; }
    </style>
</head>
<body>

    <nav class="navbar-custom d-flex justify-content-between align-items-center">
        <h4 class="m-0"><i class="fas fa-chart-line text-primary me-2"></i>DataHub</h4>
        <div>
            <a href="{% url 'admin:index' %}" class="btn btn-sm btn-outline-primary me-2"><i class="fas fa-cog"></i> Admin</a>
            <a href="?logout=1" class="btn btn-sm btn-danger"><i class="fas fa-sign-out-alt"></i> Sair</a>
        </div>
    </nav>

    <div class="filter-bar">
        <div class="multi-select-box">
            <label class="small fw-bold text-muted text-uppercase" style="font-size: 10px;">Temas</label>
            <div class="form-select form-select-sm">Filtrar Temas</div>
            <div id="list-temas" class="multi-select-menu"></div>
        </div>
        <div class="multi-select-box">
            <label class="small fw-bold text-muted text-uppercase" style="font-size: 10px;">Rótulos</label>
            <div class="form-select form-select-sm">Filtrar Rótulos</div>
            <div id="list-rotulos" class="multi-select-menu"></div>
        </div>
        <button onclick="resetFilters()" class="btn btn-sm btn-link text-muted mb-1 text-decoration-none">Limpar</button>
    </div>

    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <h5 class="px-3 mb-3 fw-bold">Quadro Kanban</h5>
                <div class="kanban-container">
                    {% for situacao, tarefas_list in kanban_data.items %}
                    <div class="kanban-column">
                        <div class="kanban-header">
                            <span>{{ situacao.nome }}</span>
                            <span class="badge bg-white text-dark border js-count">{{ tarefas_list|length }}</span>
                        </div>
                        
                        <div class="kanban-cards-wrapper">
                            {% for d in tarefas_list %}
                            <div class="kanban-card js-filterable" 
                                 data-tema="{{ d.tema.nome|default:'Sem Tema' }}"
                                 data-rotulos="{% for r in d.rotulos.all %}{{ r.nome }}{% if not forloop.last %},{% endif %}{% endfor %}"
                                 style="border-left-color: {{ situacao.cor_hex }}" 
                                 onclick="window.open('{% url 'admin:core_demanda_change' d.id %}', '_blank')">
                                
                                <span class="badge bg-light text-dark mb-2" style="font-size: 10px;">{{ d.tema.nome|default:"Sem Tema" }}</span>
                                <h6>{{ d.titulo }}</h6>
                                
                                <div class="progress mb-2" style="height: 6px;" title="Progresso: {{ d.progresso_total|default:0 }}%">
                                    <div class="progress-bar bg-success" role="progressbar" 
                                         style="width: {{ d.progresso_total|default:0|stringformat:'f' }}%"></div>
                                </div>

                                <div class="meta-info d-flex justify-content-between align-items-center">
                                    <span>
                                        <i class="fas fa-check-double text-success me-1"></i>
                                        {{ d.stats_tarefas.concluidas|default:0 }}/{{ d.stats_tarefas.total|default:0 }} tarefas
                                    </span>
                                    <span class="badge bg-secondary" style="font-size: 9px;">
                                        {{ d.progresso_total|default:0 }}% (Hrs)
                                    </span>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="row px-3 pb-5 mt-4">
            <div class="col-12">
                <div class="card dashboard-card border-0 shadow-sm">
                    <div class="card-header bg-white py-3"><h6 class="m-0 fw-bold">Lista de Demandas</h6></div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th class="ps-4">Demanda</th>
                                        <th>Situação</th>
                                        <th>Responsável</th>
                                        <th>Progresso (Qtd)</th>
                                        <th class="text-center">Ação</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for demanda in demandas %}
                                    <tr class="js-filterable" 
                                        data-tema="{{ demanda.tema.nome|default:'Sem Tema' }}"
                                        data-rotulos="{% for r in demanda.rotulos.all %}{{ r.nome }}{% if not forloop.last %},{% endif %}{% endfor %}">
                                        <td class="ps-4">
                                            <strong>{{ demanda.titulo }}</strong><br>
                                            <small class="text-muted">{{ demanda.tema.nome|default:"Sem Tema" }}</small>
                                        </td>
                                        <td>
                                            {% if demanda.situacao %}
                                            <span class="badge" style="background-color: {{ demanda.situacao.cor_hex }}">
                                                {{ demanda.situacao.nome }}
                                            </span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if demanda.responsavel %}
                                                {{ demanda.responsavel.get_full_name|default:demanda.responsavel.username }}
                                            {% else %}
                                                <span class="text-muted">Não atribuído</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="d-flex align-items-center gap-2">
                                                <div class="progress flex-grow-1" style="height: 8px; width: 80px;">
                                                    <div class="progress-bar bg-info" style="width: {{ demanda.stats_tarefas.percent_qtd|default:0|stringformat:'f' }}%"></div>
                                                </div>
                                                <small style="font-size: 10px;">{{ demanda.stats_tarefas.concluidas|default:0 }}/{{ demanda.stats_tarefas.total|default:0 }}</small>
                                            </div>
                                        </td>
                                        <td class="text-center">
                                            <a href="{% url 'admin:core_demanda_change' demanda.id %}" target="_blank" class="text-primary">
                                                <i class="fas fa-external-link-alt"></i>
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function runFilters() {
            const selectedTemas = Array.from(document.querySelectorAll('.cb-tema:checked')).map(c => c.value);
            const selectedRotulos = Array.from(document.querySelectorAll('.cb-rotulo:checked')).map(c => c.value);

            document.querySelectorAll('.js-filterable').forEach(el => {
                const tema = el.dataset.tema;
                const rotulosArr = el.dataset.rotulos ? el.dataset.rotulos.split(',') : [];

                const matchTema = selectedTemas.length === 0 || selectedTemas.includes(tema);
                const matchRotulo = selectedRotulos.length === 0 || rotulosArr.some(r => selectedRotulos.includes(r));

                el.style.display = (matchTema && matchRotulo) ? '' : 'none';
            });

            document.querySelectorAll('.kanban-column').forEach(col => {
                const count = col.querySelectorAll('.kanban-card:not([style*="display: none"])').length;
                col.querySelector('.js-count').textContent = count;
            });
        }

        function resetFilters() {
            document.querySelectorAll('.cb-tema, .cb-rotulo').forEach(c => c.checked = false);
            runFilters();
        }

        document.addEventListener('DOMContentLoaded', () => {
            const temas = new Set();
            const rotulos = new Set();

            document.querySelectorAll('.js-filterable').forEach(el => {
                temas.add(el.dataset.tema);
                if(el.dataset.rotulos) el.dataset.rotulos.split(',').forEach(r => rotulos.add(r));
            });

            const temaDiv = document.getElementById('list-temas');
            [...temas].sort().forEach(t => {
                temaDiv.innerHTML += `<label class="opt-item"><input type="checkbox" class="cb-tema" value="${t}" onchange="runFilters()"> ${t}</label>`;
            });

            const rotDiv = document.getElementById('list-rotulos');
            [...rotulos].sort().forEach(r => {
                rotDiv.innerHTML += `<label class="opt-item"><input type="checkbox" class="cb-rotulo" value="${r}" onchange="runFilters()"> ${r}</label>`;
            });
        });
    </script>
</body>
</html>