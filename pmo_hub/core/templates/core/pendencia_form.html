<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="utf-8">
    <title>Registrar Pendência</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="p-4 bg-light">
    <div class="container bg-white p-4 shadow-sm rounded">
        {% if msg_sucesso %}
            <div class="text-center">
                <div class="alert alert-success">Pendência registrada com sucesso!</div>
                <p>A página será atualizada e esta janela fechará...</p>
            </div>
            <script>
                setTimeout(function(){
                    if (window.opener) { window.opener.location.reload(); }
                    window.close();
                }, 1500);
            </script>
        {% else %}
            <h5>Travar Demanda em: <span class="text-primary">{{ situacao_destino.nome }}</span></h5>
            <p class="text-muted">Demanda: {{ demanda.titulo }}</p>
            <hr>
            <form method="post">
                {% csrf_token %}
                
                <div class="mb-3">
                    <label class="form-label fw-bold">1. Qual tarefa está gerando a pendência?</label>
                    <select name="tarefa_id" class="form-select" required>
                        <option value="">Selecione a tarefa...</option>
                        {% for tarefa in tarefas_disponiveis %}
                            <option value="{{ tarefa.id }}">{{ tarefa.nome }}</option>
                        {% empty %}
                            <option value="" disabled>ERRO: Não há tarefas abertas nesta demanda.</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">2. Responsabilidade</label>
                    <select name="responsabilidade" class="form-select">
                        {% for val, label in choices %}
                            <option value="{{ val }}">{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">3. Descrição do Impedimento</label>
                    <textarea name="pendencia_descricao" class="form-control" rows="4" required placeholder="Explique o motivo do travamento..."></textarea>
                </div>

                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-warning w-100" {% if not tarefas_disponiveis %}disabled{% endif %}>
                        Confirmar Pendência
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="window.close()">Cancelar</button>
                </div>
            </form>
        {% endif %}
    </div>
</body>
</html>