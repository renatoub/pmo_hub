<!-- pmo_hub\templates\admin\timeline.html -->
{% extends "admin/base_site.html" %}
{% load static %}

{% block extrahead %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/frappe-gantt/0.6.1/frappe-gantt.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/frappe-gantt/0.6.1/frappe-gantt.min.js"></script>
    <style>
        /* Resolve sobreposição e garante 100% de largura */
        .content-wrapper { background: #f4f6f9 !important; z-index: 1; }
        .content { padding: 10px !important; }
        
        #gantt-svg {
            display: block;
            width: 100%;
            min-width: 1200px; /* Garante que o grid não esprema as barras */
        }

        .gantt-wrapper {
            width: 100%;
            overflow-x: auto; /* Permite scroll horizontal se o min-width for atingido */
            position: relative;
        }

        /* Estilo das barras conforme sua imagem de referência */
        .bar-demanda .bar { fill: #a3c2ff; stroke: #3b82f6; stroke-width: 1; }
        .bar-demanda .bar-progress { fill: #3b82f6; }
        .bar-demanda .bar-label { fill: #333; font-weight: 500; font-size: 12px; }
    </style>
{% endblock %}

{% block content %}
    <div class="container-fluid">
        <div class="row m-0">
            <div class="col-12 p-0">
                <div class="card card-primary card-outline shadow-sm">
                    <div class="card-header d-flex align-items-center" style="padding: .75rem 1.25rem;">
                        <h3 class="card-title m-0">
                            <i class="fas fa-stream mr-2"></i> Timeline PMO Hub
                        </h3>
                        <div class="card-tools ml-auto">
                            <div class="btn-group">
                                <button type="button" class="btn btn-xs btn-default" onclick="changeView('Day')">Dia</button>
                                <button type="button" class="btn btn-xs btn-default" onclick="changeView('Week')">Semana</button>
                                <button type="button" class="btn btn-xs btn-default" onclick="changeView('Month')">Mês</button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="gantt-wrapper">
                            <svg id="gantt-svg"></svg>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            fetch('/gantt-data/')
                .then(res => res.json())
                .then(tasks => {
                    if (tasks.length === 0) return;

                    // Forçar o refresh do SVG limpando o conteúdo interno antes de iniciar
                    document.getElementById('gantt-svg').innerHTML = '';

                    const gantt = new Gantt("#gantt-svg", tasks, {
                        header_height: 50,
                        column_width: 30,
                        step: 24,
                        view_modes: ['Day', 'Week', 'Month'],
                        bar_height: 25,
                        bar_corner_radius: 3,
                        padding: 18,
                        view_mode: 'Week',
                        language: 'pt-br',
                        custom_popup_html: function(task) {
                            return `
                                <div class="p-3" style="width:250px; background:#fff; border: 1px solid #ccc; border-radius: 5px;">
                                    <h6 style="margin-top:0;">${task.name}</h6>
                                    <p class="small text-muted mb-0">Progresso: <b>${task.progress}%</b></p>
                                </div>
                            `;
                        }
                    });

                    window.gantt_instance = gantt;
                    
                    // O SEGREDO: O Jazzmin usa transições. Precisamos de um delay maior 
                    // para o navegador calcular a largura real do container pai.
                    setTimeout(() => { 
                        window.dispatchEvent(new Event('resize')); 
                    }, 600);
                });
        });

        function changeView(mode) {
            if (window.gantt_instance) {
                window.gantt_instance.change_view_mode(mode);
            }
        }
    </script>
{% endblock %}