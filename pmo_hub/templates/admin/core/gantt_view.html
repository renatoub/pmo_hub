{% extends "admin/base_site.html" %}
{% block extrahead %}
<script src="https://cdn.tailwindcss.com"></script>
<style>
    .bar-demanda { background-color: #3b82f6 !important; border: 1px solid #2563eb !important; color: white !important; }
    .day-col { border-right: 1px solid #e2e8f0; flex: 1; text-align: center; font-size: 9px; padding: 10px 0; min-width: 40px; }
    .weekend { background-color: #f8fafc; }
</style>
{% endblock %}

{% block content %}
<div class="m-4">
    <div class="flex items-center justify-between mb-4 bg-white p-4 rounded-lg border border-slate-200">
        <div class="flex gap-2">
            <a href="?week_offset={{ prev_offset }}" class="px-4 py-2 bg-slate-100 hover:bg-slate-200 rounded text-sm font-bold">← Anterior</a>
            <a href="?week_offset=0" class="px-4 py-2 bg-slate-100 hover:bg-slate-200 rounded text-sm font-bold">Hoje</a>
            <a href="?week_offset={{ next_offset }}" class="px-4 py-2 bg-slate-100 hover:bg-slate-200 rounded text-sm font-bold">Próxima →</a>
        </div>
        <div class="text-slate-600 font-medium">
            Período: <span class="text-blue-600 font-bold">{{ start_date_display }}</span> até <span class="text-blue-600 font-bold">{{ end_date_display }}</span>
        </div>
    </div>

    <div class="bg-white rounded-xl border border-slate-200 overflow-hidden shadow-sm">
        <div class="overflow-x-auto custom-scrollbar">
            <div class="min-w-[1400px]">
                <div class="flex border-b border-slate-200 bg-slate-50 sticky top-0 z-30">
                    <div class="w-80 p-4 font-bold border-r border-slate-200 bg-slate-50 sticky left-0 z-40">Demanda</div>
                    <div id="day-labels" class="flex-1 flex bg-slate-50"></div>
                </div>
                <div id="gantt-body" class="divide-y divide-slate-100"></div>
            </div>
        </div>
    </div>
</div>

<script>
const START_VIEW = new Date("{{ start_iso }}");
const END_VIEW = new Date("{{ end_iso }}");
const TOTAL_DAYS = 14; // Janela de 2 semanas

function getPos(dateStr) {
    const d = new Date(dateStr);
    const diffTime = d - START_VIEW;
    const diffDays = diffTime / (1000 * 60 * 60 * 24);
    return (diffDays / TOTAL_DAYS) * 100;
}

async function initGantt() {
    const res = await fetch('../gantt-data/');
    const allDemands = await res.json();
    
    // Filtra apenas demandas que interceptam a janela visual atual
    const demands = allDemands.filter(d => {
        const s = new Date(d.start);
        const e = new Date(d.end);
        return s <= END_VIEW && e >= START_VIEW;
    });

    // Renderiza Labels de Dias (D1, D2...)
    let dayHtml = '';
    for(let i=0; i < TOTAL_DAYS; i++) {
        const current = new Date(START_VIEW);
        current.setDate(current.getDate() + i);
        const isWeekend = current.getDay() === 0 || current.getDay() === 6;
        dayHtml += `<div class="day-col ${isWeekend ? 'weekend text-rose-400' : ''}">
            ${current.getDate()}/${current.getMonth()+1}<br><span class="opacity-50">${['Dom','Seg','Ter','Qua','Qui','Sex','Sáb'][current.getDay()]}</span>
        </div>`;
    }
    document.getElementById('day-labels').innerHTML = dayHtml;

    document.getElementById('gantt-body').innerHTML = demands.map(d => {
        let startPercent = getPos(d.start);
        let endPercent = getPos(d.end);
        
        // Clip das barras para os limites da visão atual
        const visibleStart = Math.max(0, startPercent);
        const visibleEnd = Math.min(100, endPercent);
        let width = visibleEnd - visibleStart;
        if (width < 1) width = 1; // Visibilidade mínima para tarefas de 1 dia

        return `
            <div class="flex group hover:bg-slate-50/80 transition-all">
                <div class="w-80 p-3 border-r border-slate-200 bg-white group-hover:bg-slate-50 sticky left-0 z-10">
                    <div class="text-sm font-semibold text-slate-800 truncate">${d.name}</div>
                    <div class="text-[9px] text-slate-400 font-bold uppercase">${d.start} à ${d.end}</div>
                </div>
                <div class="flex-1 relative h-16 flex items-center bg-white">
                    ${Array.from({length: TOTAL_DAYS}).map((_, i) => `
                        <div class="absolute h-full border-r border-slate-100" style="left:${(i/TOTAL_DAYS)*100}%; width: 1px;"></div>
                    `).join('')}
                    
                    <div class="h-8 rounded shadow-sm flex items-center px-2 text-[10px] font-bold border ${d.custom_class || 'bar-demanda'}"
                         style="margin-left: ${visibleStart}%; width: ${width}%; z-index: 5; position: absolute; white-space: nowrap;">
                        <span class="truncate">${d.progress}%</span>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}
initGantt();
</script>
{% endblock %}