name: Deploy Unificado
run-name: Deploy ${{ github.ref_name }}

on:
  push:
    branches: [main, dev]

jobs:
  deploy:
    # O nome dinâmico agora usa o github.ref_name para evitar erro de matriz
    name: deploy (${{ github.ref_name }})
    runs-on: self-hosted
    
    env:
      # Lógica de variáveis baseada na branch do push
      TARGET_PORT: ${{ github.ref_name == 'main' && '1234' || '2345' }}
      SERVICE_NAME: ${{ github.ref_name == 'main' && 'DataHub-EqtOne' || 'DataHub-EqtOne-Dev' }}
      BASE_PATH: "C:\\EQTONE\\pmo_hub\\pmo_hub_${{ github.ref_name }}"

    steps:
      - name: 1. Gerar Timestamp e Status do Deploy
        shell: powershell
        run: |
          $TIMESTAMP = Get-Date -Format "yyyyMMdd_HHmm"
          echo "BACKUP_DATE=$TIMESTAMP" >> $env:GITHUB_ENV
          Write-Host "Iniciando deploy na pasta $env:BASE_PATH na porta $env:TARGET_PORT"

      - name: 2. Criando backup do banco de dados
        shell: cmd
        working-directory: ${{ env.BASE_PATH }}
        run: |
          if not exist "..\backups" mkdir "..\backups"
          copy pmo_hub\db.sqlite3 ..\backups\db_${{ github.ref_name }}_%BACKUP_DATE%.sqlite3
          uv run python .\pmo_hub\manage.py dumpdata --natural-foreign --natural-primary -e contenttypes -e auth.Permission --indent 2 > ..\backups\dump_${{ github.ref_name }}_%BACKUP_DATE%.json

      - name: 3. Atualizar Código (Git Pull)
        shell: cmd
        working-directory: ${{ env.BASE_PATH }}
        run: |
          git fetch origin ${{ github.ref_name }}
          git reset --hard origin/${{ github.ref_name }}
          git pull origin ${{ github.ref_name }}

      - name: 4. Migrations
        shell: cmd
        working-directory: ${{ env.BASE_PATH }}
        run: uv run python pmo_hub\manage.py migrate --noinput

      - name: 5. Restart Service via NSSM
        shell: powershell
        run: |
          Write-Host "Reiniciando $env:SERVICE_NAME..."
          Stop-Service -Name "$env:SERVICE_NAME" -Force -ErrorAction SilentlyContinue
          Start-Sleep -Seconds 5
          Start-Service -Name "$env:SERVICE_NAME"
          
          # Validação final
          Start-Sleep -Seconds 5
          $status = (Get-Service -Name "$env:SERVICE_NAME").Status
          if ($status -ne "Running") { 
            Write-Error "O serviço não subiu corretamente. Status: $status"
            exit 1
          }